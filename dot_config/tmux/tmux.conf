set -g @plugin 'tmux-plugins/tpm'

set -g @plugin 'erikw/tmux-dark-notify'
set -g @dark-notify-theme-path-dark  "$HOME/.config/tmux/themes/flexoki-dark.tmuxtheme"
set -g @dark-notify-theme-path-light "$HOME/.config/tmux/themes/flexoki-light.tmuxtheme"

# ============================================================================
# 效率插件配置
# ============================================================================

# 会话管理 - tmux-sessionx (核心效率工具)
set -g @plugin 'omerxx/tmux-sessionx'
set -g @sessionx-bind 'o'                           # 绑定快捷键为 'o'
set -g @sessionx-window-mode 'on'                   # 启用窗口模式
set -g @sessionx-tree-mode 'on'                     # 启用树状模式
set -g @sessionx-preview-enabled 'on'               # 启用预览
set -g @sessionx-preview-location 'right'           # 预览位置
set -g @sessionx-preview-ratio '60%'                # 预览比例
set -g @sessionx-zoxide-mode 'on'                   # 启用 zoxide 集成
set -g @sessionx-filters 'zoxide'                   # 使用 zoxide 过滤器
set -g @sessionx-filter-current 'false'             # 不过滤当前会话
set -g @sessionx-bind-kill-session 'ctrl-x'         # 杀死会话的快捷键
set -g @sessionx-bind-new-window 'ctrl-n'           # 新建窗口的快捷键

# 窗口名称美化 - 显示程序图标
set -g @plugin 'joshmedeski/tmux-nerd-font-window-name'
set -g @tmux-nerd-font-window-name-show-name true   # 显示窗口名称
set -g @tmux-nerd-font-window-name-show-flags true  # 显示窗口标志

# Vim/Neovim 集成
set -g @plugin 'christoomey/vim-tmux-navigator'

# 会话持久化
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-restore 'on'                      # 自动恢复会话
set -g @continuum-save-interval '15'                # 保存间隔(分钟)
set -g @resurrect-capture-pane-contents 'on'        # 保存面板内容
set -g @resurrect-processes 'ssh psql mysql sqlite3 "python manage.py runserver" "npm run dev" "yarn dev"'  # 保存特定进程

# 系统监控配置 (使用插件默认颜色，可通过 @cpu_* 和 @batt_* 变量自定义)

# 内容提取和搜索
set -g @plugin 'laktak/extrakto'                    # 智能内容提取
set -g @plugin 'wfxr/tmux-fzf-url'                  # URL 提取

# 系统监控
set -g @plugin 'tmux-plugins/tmux-cpu'              # CPU 使用率显示
set -g @plugin 'tmux-plugins/tmux-battery'          # 电池状态显示

# 浮动窗口
set -g @plugin 'omerxx/tmux-floax'                  # 浮动窗口管理
set -g @floax-bind 'p'                              # 快捷键: Ctrl-a + p
set -g @floax-bind-menu 'P'                          # 菜单快捷键: Ctrl-a + P
set -g @floax-width '85%'                            # 浮动窗口宽度
set -g @floax-height '85%'                           # 浮动窗口高度
set -g @floax-border-color '#4385be'                 # 边框颜色 (Flexoki blue)
set -g @floax-text-color '#cecdc3'                   # 文字颜色 (Flexoki foreground)
set -g @floax-change-path 'true'                     # 自动切换路径
set -g @floax-session-name 'floax'                   # 会话名称
set -g @floax-title 'FloaX - 浮动窗口'               # 窗口标题

# 菜单系统
set -g @plugin 'jaclu/tmux-menus'

# ============================================================================
# 透明背景和视觉效果
# ============================================================================

# 窗口透明背景 (玻璃态效果)
set -g window-style 'bg=terminal'                         # 非活跃窗口透明
set -g window-active-style 'bg=terminal'                  # 活跃窗口透明

# 面板边框透明
set -g pane-border-style 'bg=terminal'                    # 面板边框透明
set -g pane-active-border-style 'bg=terminal,fg=#4385be' # 活跃面板蓝色边框

# ============================================================================
# 状态栏配置 (包含系统监控)
# ============================================================================

# 自定义状态栏样式 (保持不透明以确保可读性)
set -g status-style "bg=#CCCCFF,fg=#000000"               # 浅蓝背景，黑色文字
set -g status-left-style "bg=#CCCCFF,fg=#000000,bold"     # 左侧状态栏样式
set -g status-right-style "bg=#CCCCFF,fg=#000000"         # 右侧状态栏样式

# 自定义状态栏 - 集成 CPU、内存、电池和负载信息
set -g status-right "#{cpu_icon} #{cpu_percentage} | #{ram_icon} #{ram_percentage} | LOAD: #(cut -d' ' -f1-3 /proc/loadavg) | #{battery_icon} #{battery_percentage} #{battery_remain} | #[fg=#000000]%H:%M %Y-%m-%d"
set -g status-right-length 170

# ============================================================================
# 基础设置优化 (整合 tmux-sensible)
# ============================================================================

# 服务器级别优化
set -s escape-time 0                              # 解决 vim 模式切换延迟

# 真彩色支持
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",*256col*:Tc"

# 界面优化
set -g mouse on                                    # 启用鼠标支持
set -g status-keys emacs                          # 命令行使用 emacs 键绑定
set -g focus-events on                            # 启用焦点事件
set -g display-time 4000                          # 消息显示时间 4 秒
set -g status-interval 5                          # 状态栏刷新间隔 5 秒
setw -g aggressive-resize on                      # 智能调整窗口大小

# 状态栏位置
set -g status-position top

# 窗口和面板起始编号
set -g base-index 1
set -g pane-base-index 1
setw -g pane-base-index 1

# 窗口重新编号
set -g renumber-windows on

# 历史限制
set -g history-limit 100000

# 快捷键优化
# 使用 Ctrl-a 作为前缀键 (更易按)
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# tmux-sensible 默认按键绑定
bind a last-window                              # 双击前缀键切换到上一个窗口
bind C-p previous-window                        # Ctrl-p 切换到上一个窗口
bind C-n next-window                            # Ctrl-n 切换到下一个窗口

# 窗口分割快捷键 (更直观)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# 窗口切换快捷键 (vim 风格)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# 窗口大小调整 (vim 风格)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# 快速重载配置
bind R run-shell "tmux source-file ~/.config/tmux/tmux.conf > /dev/null; tmux display-message 'Config reloaded!'"

# 快速重载配置 (兼容旧绑定)
bind r source-file ~/.config/tmux/tmux.conf \; display-message "Config reloaded!"

# 系统监控快捷键 - 当 Load Average 过高时快速排查
bind L display-popup -E -w 90% -h 90% "htop -s PERCENT_CPU"  # 按 CPU 占用排序查看进程

# ============================================================================
# 插件初始化 (必须放在最后)
# ============================================================================
run '~/.tmux/plugins/tpm/tpm'
